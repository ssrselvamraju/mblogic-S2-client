<!DOCTYPE HTML>
<!-- This is an HTML5 doc type. -->

<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<link rel="icon" type="image/png" href="/systemicon.png" >
<!-- General page layout style sheet. -->
<link rel="stylesheet" href="/statuspagelayout.css" type="text/css">

<!-- This controls the page display. -->
<script type="text/javascript" src="/statuspages/libstatusserver.js"></script>
<script type="text/javascript" src="/statuspages/libdata.js"></script>
<script type="text/javascript" src="/statuspages/libdatapost.js"></script>
<script type="text/javascript" src="/statuspages/libstatutils.js"></script>
<script type="text/javascript" src="/statuspages/libparamedit.js"></script>
<!-- Message text definitions. -->
<script type="text/javascript" src="/statuspages/libtexts_en.js"></script>

<!-- Native JSON doesn't seem to be working in Opera 10.10. -->
<script type="text/javascript" src="/statuspages/json2.js"></script>

 
<title>Communications Servers Configuration</title>

</head>

<body onload="pageinit();">

<div id="filler">

	<div id="header">
		<p class="headlogo">
			<img src="/systemlogo.png" width="200" alt="MB Logic Logo">
			<span class="headtitle1">MBLogic </span>
			<span class="headtitle2"> for an open world in automation</span>
		</p>
	</div>



	<!-- This is the standard nav bar. -->
	<div id="nav">
		<ul>
			<li><a href="/statussystem.html">Home</a></li>
			<li><a href="/statuspages/statusconfigure.html">Configure</a></li>
			<li><a href="/statuspages/statuscontrol.html">Control</a></li>
			<li><a href="/statuspages/statusmonitor.html">Monitor Data</a></li>
			<li><a href="/statuspages/statussysmon.html">System</a></li>
			<li><a href="/statuspages/statusxref.html">XRef</a></li>
			<li><a href="/helpmain.html">Help</a></li>
		</ul>
	</div>


	
<div id="datadisplay">

<!-- Acknowledge save request. This is located in this position to cover
	the normal page elements be leave the navigation menu exposed. -->
<div id="saverequestshow" class="datahide">
	<!-- The style should be resized to the actual width and height at run time. -->
	<div id="screenmask" class="shutdownmask" style="position:absolute;">
	</div>
	<div class="shutdownbuttonback" style="position:absolute;
					width:250px;height:100px;left:300px;top:350px;">
		<p>Saving ...
		<img src="/spinner.gif" width="64" alt="spinner">
		</p>
	</div>
</div>

<h1>Communications Servers Configuration</h1>

<!-- This enables/disables editing. -->
<form name="editmode" >
	<p onclick="EditButtonMode();">
		View Only: <input type="radio" name="mode" value="view" checked="checked" />
		Edit: <input type="radio" name="mode" value="edit" />
	</p>
</form>

<!-- This is used to save the configuration. -->
<div id="savedata" class="datahide">
	<div class="editconfigback" style="position:fixed;
		width:150px;height:70px;left:850px;top:10px;">
			<p><button id="saveallbutton" class="editconfigbuttons"
						onclick="SaveData();">Save All</button>
			</p>
	</div>
</div>

<!-- This is used to display error messages from the server. -->
<div id="serversaveerror" class="datahide">
	<hr>
	<p class="errortextparagraph">
	A system error was reported by the server when
	attempting to save the configuration.</p>
</div>

<div id="saveerrors" class="datahide">
	<hr>
		<h3>Errors Saving Configuration:</h3>
		<table id="saveerrortable" class="errortable"  border="1">
		</table>
</div>


<hr>

<h2>Server ID</h2>

	<table class="displaytable" id="serveridtable"  border="1" onclick="EditServerID();">
		<tr> <th>Server ID</th>
		<td class="t1" id="serverid"></td> </tr>
	</table>

<!-- This is used to edit the server ID configuration. -->
<div id="serveridedit" class="datahide">
	<div class="editconfigback" style="position:fixed;
		width:400px;height:200px;left:400px;top:200px;">

			<h3>Server ID</h3>
				<form name="serveridconfig" >
					<p>Server Name: 
					<input id="serveridname" class="editconfigfields" type="text" 
					 				name="serveridname" size="24" 
					 				onchange="ComServer.ServerIDChanged();" />
					</p>

				</form>

				<p><button class="editconfigbuttons"
							onclick="ServerIDEditEnter();">Change</button>
				<button class="editconfigbuttons"
							onclick="ServerIDEditCancel();">Cancel</button>
				</p>
	</div>
</div>



<hr>


<h2>TCP Servers</h2>

<table class="displaytable"  border="1" id="servertable">
	<tr>
	  	<th>Server protocol</th>
		<th>Server Name</th>
	  	<th>IP Port</th>
 	</tr>

	<tr onclick="ServerEdit('modbustcp')">
		<td class="t1">modbustcp</td>
		<td class="t1" id="modbustcp_name"></td>
		<td class="t1" id="modbustcp_port"></td>
	</tr>

	<tr onclick="ServerEdit('mbhmi')">
		<td class="t2">hmi</td>
		<td class="t2" id="hmi_name"></td>
		<td class="t2" id="hmi_port"></td>
	</tr>

	<tr onclick="ServerEdit('rhmi')">
		<td class="t1">rhmi</td>
		<td class="t1" id="rhmi_name"></td>
		<td class="t1" id="rhmi_port"></td>
	</tr>

	<tr onclick="ServerEdit('erp')">
		<td class="t2">erp</td>
		<td class="t2" id="erp_name"></td>
		<td class="t2" id="erp_port"></td>
	</tr>

	<tr onclick="ServerEdit('status')">
		<td class="t1">status</td>
		<td class="t1" id="status_name"></td>
		<td class="t1" id="status_port"></td>
	</tr>

	<tr onclick="ServerEdit('help')">
		<td class="t2">help</td>
		<td class="t2" id="help_name"></td>
		<td class="t2" id="help_port"></td>
	</tr>

	<tr onclick="ServerEdit('generic')">
		<td class="t1">generic</td>
		<td class="t1" id="generic_name"></td>
		<td class="t1" id="generic_port"></td>
	</tr>

	<tr onclick="ServerEdit('mbrest')">
		<td class="t2">mbrest</td>
		<td class="t2" id="mbrest_name"></td>
		<td class="t2" id="mbrest_port"></td>
	</tr>

	<!-- Data will be inserted here by the Javscript. -->

</table>


<!-- This is used to edit the server configuration. -->
<div id="serverconfig" class="datahide">
	<div class="editconfigback" style="position:fixed;
		width:400px;height:250px;left:400px;top:200px;">

			<p><span id="protocolheading" class="itemtitle"></span>
			</p> 

				<form name="serverconfig" >
					<p>Server Name: 
					<input id="servername" class="editconfigfields" type="text" 
					 				name="servername" size="24" 
					 				onchange="ComServer.ServerNameChanged();" />
					</p>

					<p>Port: 
					<input id="port" class="editconfigfields" type="number" 
									name="port" size="10"  
									min="0" max="65535"
									onchange="ComServer.PortNumberChanged();"/>
					</p>

					<!-- This is used to store the protocol name. -->
					<input type="hidden" name="protocol">

				</form>

				<p><button class="editconfigbuttons"
							onclick="ServerEditEnter();">Change</button>
				<button class="editconfigbuttons"
							onclick="ServerEditCancel();">Cancel</button>
				<button class="editconfigbuttons"
							onclick="ServerEditDelete();">Delete</button>
				</p>
	</div>
</div>


<hr>

	<!-- Data table expanded register map parameters. -->	

	<h2>Data Table Expanded Register Map</h2>

		<table class="displaytable" id="expregtable"  border="1" onclick="EditExpRegs();">
			<tr> <th>Expanded Register Map</th>
			<td class="t1" id="mbaddrexp"></td> </tr>
		</table>

	<p><button onclick="ShowExpDataDetails();">Show UID Details</button>
	</p>

	<div id="expdetails" class="datahide">

	<p><button onclick="HideExpDataDetails();">Hide Details</button>
	</p>

		<div class="expdatalcolumn">

			<table class="displaytable"  border="1" id="mbuidoffset1">
				<tr>
				<th>Unit ID</th>
			  	<th>Offset</th>
			 	</tr>
	
				<!-- Data will be inserted here by the Javscript. -->
	
			</table>

		</div>

		<div class="expdatarcolumn">

			<table class="displaytable"  border="1" id="mbuidoffset2">
				<tr>
				<th>Unit ID</th>
			  	<th>Offset</th>
			 	</tr>
	
				<!-- Data will be inserted here by the Javscript. -->
	
			</table>

		</div>

		<div class="expdataclear"></div>


	</div>


<!-- This is used to edit the expanded register map configuration. -->
<div id="expreg" class="datahide">
	<div class="editconfigback" style="position:fixed;
		width:450px;height:270px;left:400px;top:200px;">

				<h3>Expanded Register Map Configure</h3>

				<form name="expregconfig" >
					<p id="expregenable" onchange="ComServer.EnableChanged();">
						Expanded Register Map: 
						<input type="radio" name="expregenable" value="disable" />Disable
						<input type="radio" name="expregenable" value="enable" />Enable
					</p>

					<div id="expregparams">
						<p>Unit ID Offset: 
						<input id="uidoffset" class="editconfigfields" type="number" 
						 				name="uidoffset" size="10" 
										min="0" 
						 				onchange="ComServer.UIDOffsetChanged();" />
						</p>

						<p>Register Factor: 
						<input id="regfactor" class="editconfigfields" type="number" 
										name="regfactor" size="10"  
										min="0" 
										onchange="ComServer.RegFactorChanged();"/>
						</p>
					</div>

				</form>

				<p><button class="editconfigbuttons"
							onclick="RegsEditEnter();">Change</button>
				<button class="editconfigbuttons"
							onclick="RegsEditCancel();">Cancel</button>
				</p>
	</div>
</div>


<hr>


<!-- Standard footer -->
<div id="footer">
	<p>Communications Configuration</p>
</div>

</div>


<!-- This is the code for creating the data in the page. -->

	<script type="text/javascript">

	// Display the details for extended data table addressing.
	function ShowExpDataDetails() {
		ComServer.ShowDetails();
	}

	// Hide the details for extended data table addressing.
	function HideExpDataDetails() {
		ComServer.HideDetails();
	}

	// Handles communications with the server.
	var libutils = new libstatutils();
	var libparams = new LibParamEdit();

	var ComServer = new ComServerDisplay(libutils, libparams);

	// Handles reading
	var host = window.location.hostname;
	var port = window.location.port;
	var ServerData = new StatusDataIF(host, port, ComServer);


	// Run a single update cycle.
	function Update() {
		// Get the soft xref data and display it.
		ServerData.SendGetRequest("/statdata/commserverstatdata.js");
	}

	// Start up and initialisation.
	function pageinit() {
		// Start, after a short delay. 
		window.setTimeout("Update()", 500);
	}

	// ========================================================
	// Close any open error message displays.
	function CloseErrors() {
		libutils.HidePageArea("serversaveerror");
		libutils.HidePageArea("saveerrors");
	}


	// ========================================================

	// Enable or disable the save button.
	function DisableSave(disable) {
		var button = document.getElementById("saveallbutton");
		if (disable) {
			button.setAttribute("disabled", "disabled");
		} else {
			button.removeAttribute("disabled");
		}
	}

	// Make sure the the save button is not disabled on page load.
	DisableSave(false);

	// Set the default page mode to "view" (not edit).
	document.forms.editmode.mode[0].checked = true;

	// Display or hide the "save data" button.
	function EditButtonMode() {

		var tablelist = ["serveridtable", "servertable", "expregtable"];
		if (ComServer.EditMode()) {
			libutils.ShowPageArea("savedata");

			// Change the table style to show it can be edited.
			libutils.SetTableListToEditEffects(tablelist);
		} else {
			libutils.HidePageArea("savedata");

			// Change the table style back to normal view mode.
			libutils.SetTableListToNormalEffects(tablelist);
		}

		// Close (hide) the error displays if they are visible.
		CloseErrors();
	}

	// ========================================================

	// Set a dialog screen mask to the actual window size.
	function ResizeMask(maskid) {
		var datadisplay = document.getElementById("datadisplay");
		var screenmask = document.getElementById(maskid);
		screenmask.style.width = datadisplay.clientWidth + "px";
		screenmask.style.height = datadisplay.clientHeight + "px";
	}

	// Save the configuration to the server.
	function SaveData() {
		// Close (hide) the error displays if they are visible.
		CloseErrors();
		// Resize the dialog mask to the current window size.
		ResizeMask("screenmask");

		// Show the progress message.
		libutils.ShowPageArea("saverequestshow");
		// Hide the save button.
		libutils.HidePageArea("savedata");

		var savedata = ComServer.FormatSaveRequest();
		var savecmd = new StatusDataSend(host, port, EditSaveResult);
		savecmd.SendPostRequest("/statdata/commserverstatdata.js", savedata);
	}


	// This is the response from the server for the save command.
	function EditSaveResult(responseobj) {
		// Hide the progress message, after a short delay. 
		window.setTimeout("HideSaveProgress();", 1500);

		// Check to see if there were any errors.
		ComServer.EditSaveResult(responseobj);
	}

	// Hide the progress message.
	function HideSaveProgress() {
		libutils.HidePageArea("saverequestshow");
		// Redisplay the save button.
		libutils.ShowPageArea("savedata");
	}


	// ========================================================

	// Interlock editing to one at a time.
	var CurrentEdit = "none";


	// ========================================================

	// Edit the server ID.
	function EditServerID() {
		// If not in edit mode, do not edit.
		if (!ComServer.EditMode() || CurrentEdit != "none") { return; }
		CurrentEdit = "serverid"; 

		// Disable the save button.
		DisableSave(true);

		libutils.ShowPageArea("serveridedit");
		ComServer.InitEditServerID();
	}

	// Cancel server editing by hiding the edit fields.
	function ServerIDEditCancel() {
		CurrentEdit = "none"; 
		libutils.HidePageArea("serveridedit");
		// Enable the save button.
		DisableSave(false);
	}

	// Enter the server editing information.
	function ServerIDEditEnter() {
		if (ComServer.ServerIDEditEnter()) {
			CurrentEdit = "none"; 
			libutils.HidePageArea("serveridedit");
			// Enable the save button.
			DisableSave(false);
		}
	}

	// ========================================================

	// Display the server edit fields.
	function ServerEdit(servername) {
		// If not in edit mode, do not edit.
		if (!ComServer.EditMode() || CurrentEdit != "none") { return; }
		CurrentEdit = "server"; 

		// Disable the save button.
		DisableSave(true);

		libutils.ShowPageArea("serverconfig");
		ComServer.InitServerEdit(servername);
	}

	// Cancel server editing by hiding the edit fields.
	function ServerEditCancel() {
		CurrentEdit = "none"; 
		libutils.HidePageArea("serverconfig");
		// Enable the save button.
		DisableSave(false);
	}

	// Enter the server editing information.
	function ServerEditEnter() {
		if (ComServer.ServerEditEnter()) {
			CurrentEdit = "none"; 
			libutils.HidePageArea("serverconfig");
			// Enable the save button.
			DisableSave(false);
		}
	}

	// Delete the selected server information.
	function ServerEditDelete() {
		ComServer.ServerEditDelete();
		CurrentEdit = "none"; 
		libutils.HidePageArea("serverconfig");
		// Enable the save button.
		DisableSave(false);
	}

	// ========================================================

	// Display the expanded register map edit fields.
	function EditExpRegs() {
		// If not in edit mode, do not edit.
		if (!ComServer.EditMode() || CurrentEdit != "none") { return; }
		CurrentEdit = "regs"; 

		// Disable the save button.
		DisableSave(true);

		libutils.ShowPageArea("expreg");
		ComServer.InitRegsEdit();
	}


	// Enter the expanded register map editing information.
	function RegsEditEnter() {
		if (ComServer.RegsEditEnter()) {
			CurrentEdit = "none"; 
			libutils.HidePageArea("expreg");
			// Enable the save button.
			DisableSave(false);
		}
	}

	// Cancel expanded register map editing by hiding the edit fields.
	function RegsEditCancel() {
		CurrentEdit = "none"; 
		libutils.HidePageArea("expreg");
		// Enable the save button.
		DisableSave(false);
	}

	// ========================================================



	</script>


</body>

</html>


<!-- Copyright 2008 - 2010. Michael Griffin 
This file is part of MBLogic.
MBLogic is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.
MBLogic is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the 
GNU General Public License for more details.
You should have received a copy of the GNU General Public License 
along with MBLogic. If not, see <http://www.gnu.org/licenses/>. 
-->
